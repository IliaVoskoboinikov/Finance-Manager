name: "Run KtLint"
description: "Runs KtLint, merges SARIF reports and generates Markdown + HTML reports"

inputs:
  gradle-flags:
    description: "Gradle flags"
    required: false
    default: ""

  generate-html:
    description: "Generate HTML report"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:

    - name: Run KtLint
      shell: bash
      run: |
        ./gradlew ktlintCheck --continue ${{ inputs.gradle-flags }}

    - name: Collect SARIF files
      shell: bash
      run: |
        mkdir -p ktlint-sarif
        find . -type f -path "*/build/reports/ktlint/*/*.sarif" -exec cp {} ktlint-sarif/ \;

    - name: Merge SARIF files
      shell: bash
      run: |
        if compgen -G "ktlint-sarif/*.sarif" > /dev/null; then
          jq -s '
            {
              version: "2.1.0",
              runs: [
                {
                  tool: .[0].runs[0].tool,
                  results: (map(.runs[].results) | add)
                }
              ]
            }
          ' ktlint-sarif/*.sarif > merged-ktlint.sarif
        else
          echo "No SARIF files found."
          echo '{}' > merged-ktlint.sarif
        fi

    - name: Generate detailed Markdown report
      shell: bash
      run: |
        echo "# KtLint Detailed Report" > ktlint-report.md
        echo "" >> ktlint-report.md

        total=0
        declare -A moduleIssues
        declare -A moduleDetails

        for file in $(find . -type f -path "*/build/reports/ktlint/*/*.sarif"); do
          module=$(echo "$file" | sed -E 's#^\./##' | sed -E 's#/build/reports/ktlint/.*##' | sed 's#/#:#g')

          count=$(jq '[.runs[].results[]] | length' "$file")

          if [ "$count" -gt 0 ]; then
            moduleIssues["$module"]=$(( ${moduleIssues["$module"]} + count ))
            total=$((total + count))

            details=$(jq -r '
              .runs[].results[] |
              "- `" + .locations[0].physicalLocation.artifactLocation.uri + ":" +
              (.locations[0].physicalLocation.region.startLine|tostring) + ":" +
              (.locations[0].physicalLocation.region.startColumn|tostring) +
              "`  \n  " + .message.text +
              " (" + .ruleId + ")"' "$file")

            moduleDetails["$module"]+="$details"$'\n'
          fi
        done

        echo "## ðŸ”Ž Total issues: $total" >> ktlint-report.md
        echo "" >> ktlint-report.md

        if [ "$total" -gt 0 ]; then
          echo "## ðŸ“¦ Issues by module" >> ktlint-report.md
          echo "" >> ktlint-report.md
          echo "| Module | Issues |" >> ktlint-report.md
          echo "|--------|--------|" >> ktlint-report.md

          for module in "${!moduleIssues[@]}"; do
            echo "| $module | ${moduleIssues[$module]} |" >> ktlint-report.md
          done

          echo "" >> ktlint-report.md
          echo "## ðŸ“ Detailed issues" >> ktlint-report.md
          echo "" >> ktlint-report.md

          for module in "${!moduleDetails[@]}"; do
            echo "### $module" >> ktlint-report.md
            echo "" >> ktlint-report.md
            echo "${moduleDetails[$module]}" >> ktlint-report.md
            echo "" >> ktlint-report.md
          done
        else
          echo "âœ… No issues found ðŸŽ‰" >> ktlint-report.md
        fi

        cat ktlint-report.md >> $GITHUB_STEP_SUMMARY

    - name: Setup Pandoc
      if: ${{ inputs.generate-html == 'true' }}
      uses: pandoc/actions/setup@v1

    - name: Convert Markdown to HTML
      if: ${{ inputs.generate-html == 'true' }}
      shell: bash
      run: |
        cat <<EOF > style.css
        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 40px;
          background-color: #f8f9fa;
        }
        h1, h2, h3 {
          color: #24292e;
        }
        table {
          border-collapse: collapse;
          width: 100%;
          margin-bottom: 20px;
        }
        table, th, td {
          border: 1px solid #d0d7de;
        }
        th, td {
          padding: 8px 12px;
          text-align: left;
        }
        th {
          background-color: #f6f8fa;
        }
        code {
          background-color: #f6f8fa;
          padding: 2px 4px;
          border-radius: 4px;
        }
        @media (prefers-color-scheme: dark) {
          body {
            background: #0d1117;
            color: #c9d1d9;
          }
          th {
            background-color: #161b22;
          }
          table, th, td {
            border: 1px solid #30363d;
          }
        }
        EOF

        pandoc ktlint-report.md \
          -f gfm \
          -t html \
          -s \
          --css=style.css \
          -o ktlint-report.html
